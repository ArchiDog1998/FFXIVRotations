on:
  release:
    types: [published]
name: release-update
jobs:  
    build:
      name: Build
      runs-on: windows-latest
      steps:
        - uses: actions/checkout@v2

        - name: Set up .NET
          uses: actions/setup-dotnet@v1
          with:
             dotnet-version: 7.0.x
             
        - name: Restore Dependencies
          run: dotnet restore
          
        - name: Download Dalamud
          run: |
            Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
            Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"
                      
        - name: Build Plugin
          run: |
           invoke-expression 'dotnet build --no-restore --configuration Release DefaultRotations'
           invoke-expression 'dotnet build --no-restore --configuration Release ExtraRotations'
           
        - name: Upload Artifact
          uses: actions/upload-artifact@v3
          with:
            path: |
              .\DefaultRotations\bin\Release\DefaultRotations\
              .\ExtraRotations\bin\Release\ExtraRotations\
            
    release:
        name: release
        needs: build
        if: success() && startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest

        steps:
          - uses: actions/checkout@v3

          - name: Download Build Artifact
            uses: actions/download-artifact@v3

          - name: Get release
            id: get_release
            uses: bruceadams/get-release@v1.3.2
            env:
              GITHUB_TOKEN: ${{ github.token }}

          - name: Upload DefaultRotations Asset
            uses: actions/upload-release-asset@v1
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              upload_url: ${{ steps.get_release.outputs.upload_url }}
              asset_path: artifact/DefaultRotations.dll
              asset_name: DefaultRotations.dll
              asset_content_type: application/x-msdownload
              
          - name: Upload ExtraRotations Asset
            uses: actions/upload-release-asset@v1
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              upload_url: ${{ steps.get_release.outputs.upload_url }}
              asset_path: artifact/ExtraRotations.dll
              asset_name: ExtraRotations.dll
              asset_content_type: application/x-msdownload
